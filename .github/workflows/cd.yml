name: Publish

on:
  push:
    branches:
      - 'master'
      - 'develop'
      - 'test'
      - 'stg'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    container:
      image: docker:rc-git
    steps:
    -
      name: Checkout Code
      uses: actions/checkout@v3
    -
      name: Copy CI files to root
      run: |
        cd /app
        cp .circleci/data/auth.json .
        cp .circleci/data/docker-compose.yml .
        cp .circleci/data/Dockerfile .
        cp .circleci/data/wait-for-mysql.sh .
        cp .circleci/data/magento2_module_install.sql .
    -
      name: Build image base for modifications
      run: |
        cd /app
        ls
        docker compose up -d
    -
      name: Activate and setup Plugin
      run: docker ps
    - 
      name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: error
        path: /error
    -
      name: Prepare Commit and push Docker image
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ./Dockerfile
        path: true
        tags: ${{ secrets.DOCKER_ACCOUNT }}/${{ github.repository }}:${{ github.ref }}
    -
      name: Commit and push Docker image
      run: |
        sleep 5 && docker stop magento2_bitnami
        docker login ${{ secrets.DOCKER_ACCOUNT }} -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
        docker commit magento2_bitnami "${{ secrets.DOCKER_ACCOUNT }}/${{ github.repository }}:${{ github.ref }}"
        docker push "${{ secrets.DOCKER_ACCOUNT }}/${{ github.repository }}:${{ github.ref }}"
    - 
      name: Send deployment webhook to Rancher
      run: |
        BODY='{"push_data":{"tag":"'"${{ github.ref }}"'"},"repository":{"repo_name":"'"${{ secrets.DOCKER_ACCOUNT }}/${{ github.repository }}"'"}}'
        curl -X POST ${{ secrets.RANCHER_STG_DEPLOY_URL }} -H 'Content-Type: application/json' -d "${BODY}"
